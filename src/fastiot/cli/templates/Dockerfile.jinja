# WARNING: THIS FILE HAS BEEN AUTOGENERATED DO NOT EDIT IT!!!

### Stage: Base ###

FROM {{ module.manifest.docker_base_image }} as base
RUN apt-get update -y && apt-get upgrade -y && apt-get clean && rm -rf /var/lib/apt/lists/*

# As a convention, the workdir should always be the project root dir inside the container.
WORKDIR /opt/fastiot

# As a convention, the python source files should always be placed inside src-dir.
RUN mkdir /opt/fastiot/src
ENV PYTHONPATH=$PYTHONPATH:/opt/fastiot/src

# Install requirements
COPY install.sh ./
COPY requirements.txt ./
RUN FASTIOT_EXTRA_PYPI={{extra_pypi}} /bin/bash -e install.sh

{% if module.manifest.healthcheck == 'error_log' %}
HEALTHCHECK --retries=1 CMD if [ -s "/var/fastiot/logs/error.log" ]; then; exit 1; fi
{% endif %}

{% if module.manifest.vue %}
### Stage: vue.js ###
FROM node:14-buster-slim as build-vue
WORKDIR /opt/vue_app
COPY src/{{ module.module_package_name }}/{{ module.name }}/{{vue.src}}/package*.json /opt/vue_app/
RUN npm install
COPY src/{{ module.module_package_name }}/{{ module.name }}/{{vue.src}} /opt/vue_app/
RUN npm run build
{% endif %}

### Stage: Debug ###
FROM base as debug
# In debug mode we just want to copy everything from source to make it easier.
{% if module.manifest.vue %}
COPY --from=build-vue /opt/vue_app/{{ vue.configured_dist }} src/{{ module.module_package_name }}/{{ module.name }}/{{ vue.dst }}
{% endif %}
{% if project_config.library_package %}
COPY src/{{project_config.library_package}} /opt/fastiot/src/{{project_config.library_package}}
{% endif %}
COPY src/{{ module.module_package_name }} /opt/fastiot/src/{{ module.module_package_name }}
COPY src/{{ module.module_package_name }}/{{ module.name }}/manifest.yaml /opt/fastiot/manifest.yaml

{% if build_mode == 'release' %}

### Stage: Compile ###
FROM base as compile_lib
# In release mode we want to compile everything and only copy compiled artifacts into release container.
# The compilation takes place in this stage, so we need to compile it accordingly.
RUN apt-get update -y && apt-get install -y gcc make build-essential
RUN python3 -m pip install --extra-index-url http://{{ extra_pypi }} --trusted-host {{ extra_pypi }} --no-cache-dir nuitka "fastiot>=0.1.40" ordered-set

COPY configure.py /opt/fastiot/

{% if project_config.library_package %}
COPY src/{{project_config.library_package}} /opt/fastiot/src/{{project_config.library_package}}
RUN fastiot.cli nuitka-compile --src-dir=/opt/fastiot/src --out-dir=/opt/fastiot/output {{ project_config.library_package }}
{% endif %}

COPY src/{{ module.module_package_name }} /opt/fastiot/src/{{ module.module_package_name }}
RUN fastiot.cli nuitka-compile --src-dir=/opt/fastiot/src --out-dir=/opt/fastiot/output {{ module.module_package_name }}


### Stage: Release ###
FROM base

# Nuitka compiles "__file__"-variable relative to current location. So we have to place everything inside "/opt/fastiot/src".
COPY --from=compile_lib /opt/fastiot/output/*.so /opt/fastiot/src/
COPY --from=compile_lib /opt/fastiot/src/{{ module.module_package_name }}/{{ module.name }}/run.py /opt/fastiot/src/{{ module.module_package_name }}/{{ module.name }}/run.py
{% for module_dir_to_copy in module.manifest.copy_dirs_to_container %}
COPY --from=compile_lib /opt/fastiot/src/{{ module.module_package_name }}/{{ module.name }}/{{ module_dir_to_copy }} /opt/fastiot/src/{{ module.module_package_name }}/{{ module.name }}/{{ module_dir_to_copy }}
{% endfor %}
{% endif %}

{% if module.manifest.vue %}
COPY --from=build-vue /opt/vue_app/{{ vue.configured_dist }} src/{{ module.module_package_name }}/{{ module.name }}/{{ vue.dst }}
{% endif %}

COPY src/{{ module.module_package_name }}/{{ module.name }}/manifest.yaml /opt/fastiot/manifest.yaml
CMD ["python",  "/opt/fastiot/src/{{ module.module_package_name }}/{{ module.name }}/run.py"]
